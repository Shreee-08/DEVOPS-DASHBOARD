name: DevOps Dashboard CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: ðŸ§¹ Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Run Pylint
        run: pylint main.py

      - name: Notify Slack - Lint
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            Lint ${{ job.status }} for ${{ github.repository }} on ${{ github.ref_name }}
            Job: lint
          SLACK_COLOR: ${{ job.status }}

  test:
    name: âœ… Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install deps
        run: python -m pip install --upgrade pip && pip install -r requirements.txt
      - name: Run pytest
        run: pytest -q --disable-warnings --maxfail=1
      - name: Notify Slack - Test
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            Test ${{ job.status }} for ${{ github.repository }} on ${{ github.ref_name }}
            Job: test
          SLACK_COLOR: ${{ job.status }}

  build:
    name: ðŸ— Build
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Simulate build (package, create artifact)
        run: |
          echo "Build stage: create artifact"
          mkdir -p artifact && echo "artifact" > artifact/info.txt
          tar czf artifact.tar.gz artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: artifact.tar.gz
      - name: Notify Slack - Build
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            Build ${{ job.status }} for ${{ github.repository }} on ${{ github.ref_name }}
            Job: build
          SLACK_COLOR: ${{ job.status }}

  run:
    name: â–¶ Run (Log Analyzer)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./artifact
      # Checkout logs branch to get sample.log (see Enhancement 3)
      - name: Checkout logs branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: logs      # branch name where sample.log lives (create this branch, see step 3)
          path: logs-branch
      - name: Copy sample log to workspace
        run: |
          if [ -f logs-branch/sample.log ]; then
            cp logs-branch/sample.log ./sample.log
          else
            echo "No sample.log in logs branch"
          fi
      - name: Run analyzer
        run: |
          python main.py <<< "sample.log"
      - name: Show log_summary
        run: cat log_summary.txt || true ;
      - name: Notify Slack - Run
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            Run ${{ job.status }} for ${{ github.repository }} on ${{ github.ref_name }}
            Job: run
            ðŸ“Š Summary: $(cat log_summary.txt 2>/dev/null || echo "Errors=0\nWarnings=0")
          SLACK_COLOR: ${{ job.status }}

  deploy:
    name: ðŸš€ Deploy (simulated)
    runs-on: ubuntu-latest
    needs: run
    steps:
      - uses: actions/checkout@v4
      - name: Simulated Deploy
        run: echo "Deploying... (simulated)"
      - name: Notify Slack - Deploy
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            Deploy ${{ job.status }} for ${{ github.repository }} on ${{ github.ref_name }}
            Job: deploy
          SLACK_COLOR: ${{ job.status }}
